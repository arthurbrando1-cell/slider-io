<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Slider.io</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  background: #0f0f14;
  font-family: Arial, sans-serif;
}

canvas {
  display: block;
  background: radial-gradient(circle, #1b1b28, #050509);
}

#menu {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.85);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
}

#menu div {
  background: #151522;
  padding: 25px;
  border-radius: 10px;
  text-align: center;
  color: white;
}

#menu input {
  width: 200px;
  padding: 8px;
  margin-top: 10px;
}

#menu button {
  margin-top: 10px;
  padding: 8px 15px;
  cursor: pointer;
}

#score {
  position: fixed;
  top: 10px;
  left: 10px;
  color: white;
}
</style>
</head>

<body>

<div id="menu">
  <div>
    <h2>Slider.io</h2>
    <input id="nick" placeholder="Seu nick">
    <br>
    <button onclick="start()">Jogar</button>
  </div>
</div>

<div id="score">Score: 0</div>
<canvas id="game"></canvas>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getDatabase, ref, set, onValue, onDisconnect, remove
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ðŸ”¥ FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyCfdgkO3WzaxXT-djAA6MsLC2m26c9optU",
  authDomain: "slider-io.firebaseapp.com",
  databaseURL: "https://slider-io-default-rtdb.firebaseio.com",
  projectId: "slider-io",
  storageBucket: "slider-io.firebasestorage.app",
  messagingSenderId: "395647141464",
  appId: "1:395647141464:web:251cc58a3e0e90ca262c2d"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* CANVAS */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
addEventListener("resize", resize);
resize();

/* VARS */
let id, me, players = {}, foods = {};
let mouse = { x: canvas.width/2, y: canvas.height/2 };
let playing = false;

/* INPUT */
addEventListener("mousemove", e => {
  mouse.x = e.clientX;
  mouse.y = e.clientY;
});

/* START */
window.start = () => {
  const nick = document.getElementById("nick").value || "Player";
  document.getElementById("menu").style.display = "none";

  id = Math.random().toString(36).slice(2);
  me = {
    nick,
    x: Math.random()*2000-1000,
    y: Math.random()*2000-1000,
    size: 10,
    score: 0,
    color: "#" + Math.floor(Math.random()*16777215).toString(16)
  };

  const myRef = ref(db, "players/"+id);
  set(myRef, me);
  onDisconnect(myRef).remove();

  onValue(ref(db, "players"), s => players = s.val() || {});
  onValue(ref(db, "foods"), s => foods = s.val() || {});

  playing = true;
  loop();
};

/* SPAWN FOOD */
setInterval(() => {
  const fid = Math.random().toString(36).slice(2);
  set(ref(db, "foods/"+fid), {
    x: Math.random()*3000-1500,
    y: Math.random()*3000-1500
  });
}, 800);

/* GAME LOOP */
function update() {
  if (!playing) return;

  const dx = mouse.x - canvas.width/2;
  const dy = mouse.y - canvas.height/2;
  const dist = Math.hypot(dx,dy) || 1;

  me.x += dx/dist * 4;
  me.y += dy/dist * 4;

  /* COMER FOOD */
  for (let f in foods) {
    const food = foods[f];
    if (Math.hypot(me.x-food.x, me.y-food.y) < me.size) {
      me.size += 0.5;
      me.score++;
      remove(ref(db,"foods/"+f));
    }
  }

  /* COMER PLAYER */
  for (let p in players) {
    if (p === id) continue;
    const o = players[p];
    const d = Math.hypot(me.x-o.x, me.y-o.y);
    if (d < me.size && me.size > o.size+3) {
      me.size += o.size/2;
      me.score += Math.floor(o.size);
      remove(ref(db,"players/"+p));
    }
  }

  document.getElementById("score").innerText = "Score: "+me.score;
  set(ref(db,"players/"+id), me);
}

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.save();
  ctx.translate(canvas.width/2-me.x, canvas.height/2-me.y);

  /* FOODS */
  ctx.fillStyle = "#ffd166";
  for (let f in foods) {
    const food = foods[f];
    ctx.beginPath();
    ctx.arc(food.x, food.y, 3, 0, Math.PI*2);
    ctx.fill();
  }

  /* PLAYERS */
  for (let p in players) {
    const pl = players[p];
    ctx.beginPath();
    ctx.fillStyle = pl.color;
    ctx.arc(pl.x, pl.y, pl.size, 0, Math.PI*2);
    ctx.fill();

    ctx.fillStyle = "white";
    ctx.font = "12px Arial";
    ctx.fillText(pl.nick, pl.x-pl.size, pl.y-pl.size-5);
  }

  ctx.restore();
}

function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
</script>

</body>
</html>
